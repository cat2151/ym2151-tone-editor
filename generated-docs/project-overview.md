Last updated: 2025-11-12

# Project Overview

## プロジェクト概要
- YM2151 FMシンセサイザーの音色パラメータを編集するためのWindows対応Rust TUIエディタです。
- カーソル操作とキーボード入力により、デチューンやエンベロープなどの主要パラメータを直感的に調整できます。
- 編集した音色データをJSON形式で保存・読み込み、`cat-mml-play`連携によるリアルタイム試聴機能を提供します。

## 技術スタック
- フロントエンド: **Ratatui 0.28** (TUIフレームワーク、ユーザーインターフェースの構築に使用)、**Crossterm 0.28** (クロスプラットフォームのターミナル操作ライブラリ、キー入力や画面制御を担当)
- 音楽・オーディオ: **YM2151 (OPM) FM synthesis** (本エディタがターゲットとするFM音源チップのシンセシス方式)
- 開発ツール: **Rust 1.70+** (安全で高性能なアプリケーション開発に使用されるプログラミング言語)
- テスト: 情報が提供されていません。
- ビルドツール: **Cargo** (Rustプロジェクトの公式パッケージマネージャー兼ビルドシステム)
- 言語機能: **Rust** (所有権システムによるメモリ安全性、パターンマッチング、モジュールシステムなど、堅牢なアプリケーション構築をサポート)
- 自動化・CI/CD: 情報が提供されていません。
- 開発標準: 情報が提供されていません。

## ファイル階層ツリー
```
.
├── .gitignore
├── Cargo.lock
├── Cargo.toml
├── LICENSE
├── README.md
├── _config.yml
├── generated-docs/
└── src/
    └── main.rs
```

## ファイル詳細説明
- **`.gitignore`**: Gitによるバージョン管理から除外するファイルやディレクトリ（例: ビルド成果物、一時ファイル）を指定します。
- **`Cargo.lock`**: `Cargo.toml`で指定された依存関係の正確なバージョンとそのハッシュ値を記録し、ビルドの再現性を保証します。
- **`Cargo.toml`**: Rustプロジェクトのメタデータ（プロジェクト名、バージョン、著者など）、依存クレート、ビルド設定などを記述するマニフェストファイルです。
- **`LICENSE`**: プロジェクトのライセンス情報（本プロジェクトの場合、権利や利用条件を定める）が記述されています。
- **`README.md`**: プロジェクトの概要、機能、ビルドと実行方法、操作方法、依存関係など、ユーザーがプロジェクトを理解し利用するための主要な情報がまとめられています。
- **`_config.yml`**: Jekyllなどの静的サイトジェネレータでドキュメントサイトを構築する際の、設定ファイルであると推測されます（`generated-docs/`ディレクトリと関連）。
- **`generated-docs/`**: `_config.yml`と合わせて、プロジェクトのドキュメントが自動生成されて格納されるディレクトリであると推測されます。
- **`src/main.rs`**: プロジェクトのメインソースコードファイルです。アプリケーションのエントリポイントであり、TUIの初期化、イベント処理、UI描画ロジック、YM2151音色データの管理、ファイルI/Oなどが実装されています。

## 関数詳細説明
※ `src/main.rs`の具体的なコードは提供されていませんが、プロジェクトの機能説明に基づいて一般的なRust TUIアプリケーションの構造から主要な関数を推測し、説明します。

-   **`main()`**:
    -   役割: アプリケーションのエントリポイント。ターミナルの初期化を行い、アプリケーションのメインループ (`run_app`) を呼び出し、終了時にターミナルを元の状態に戻します。
    -   引数: なし
    -   戻り値: `Result<(), Box<dyn Error>>` (エラー発生の可能性を考慮)
    -   機能: ターミナルのRawモード有効化、代替スクリーンバッファへの切り替え、UI描画のためのバックエンド初期化、イベントループの実行、ターミナルクリーンアップ。

-   **`run_app<B: Backend>(terminal: &mut Terminal<B>, mut app: App)`**:
    -   役割: アプリケーションのメインループを管理します。ユーザー入力イベントのポーリング、アプリケーション状態の更新、UIの描画を繰り返し行います。
    -   引数:
        -   `terminal`: `ratatui`の`Terminal`インスタンス。UIの描画操作に使用します。
        -   `app`: アプリケーションの現在の状態を保持する`App`構造体の可変参照。
    -   戻り値: `Result<(), Box<dyn Error>>`
    -   機能: イベントの待機、`App::handle_event`によるイベント処理、`App::draw_ui`によるUI描画を、アプリケーションが終了するまで繰り返します。

-   **`App::new()`**:
    -   役割: アプリケーションの初期状態 (`App`構造体) を作成・初期化します。
    -   引数: なし
    -   戻り値: `App`インスタンス
    -   機能: YM2151音色データ（初期のFMピアノのような音色で初期化）、カーソル位置、アプリケーションの状態などを設定します。起動時にJSONファイルが存在すれば、それを読み込んで音色データを初期化します。

-   **`App::handle_event(&mut self, event: Event) -> bool`**:
    -   役割: `crossterm`から受け取ったユーザー入力イベント（主にキープレス）を処理し、アプリケーションの状態を更新します。
    -   引数:
        -   `self`: `App`構造体自身への可変参照。
        -   `event`: `crossterm`の`Event`列挙体。
    -   戻り値: `bool` (アプリケーションを終了するかどうかを示す真偽値)
    -   機能: `hjkl`によるカーソル移動、`qe`によるパラメータ増減、`ESC`キーによるアプリケーション終了と音色データの保存、などの操作を処理します。

-   **`App::update_tone_parameter(&mut self, change: i8)`**:
    -   役割: 現在カーソルが位置するYM2151音色パラメータの値を`change`で指定された量だけ増減させます。パラメータの最大値・最小値も考慮します。
    -   引数:
        -   `self`: `App`構造体自身への可変参照。
        -   `change`: パラメータの増減量 (`i8`)。
    -   戻り値: なし
    -   機能: 指定されたオペレーターとパラメータに基づいて音色データを更新し、更新後には`App::play_tone_via_cat_mml_play`を呼び出して音色を試聴させます。

-   **`App::draw_ui(&mut self, frame: &mut Frame)`**:
    -   役割: `ratatui`フレームワークを使用して、現在のアプリケーション状態（YM2151音色データ、カーソル位置、パラメータ名など）をターミナルに描画します。
    -   引数:
        -   `self`: `App`構造体自身への参照。
        -   `frame`: `ratatui`の描画コンテキスト。
    -   戻り値: なし
    -   機能: 10パラメータ×5行のグリッド表示、パラメータ名のラベル付け、カーソルの描画などを行います。

-   **`App::save_tone_data_as_json(&self)`**:
    -   役割: 現在編集中のYM2151音色データをJSON形式でファイルに保存します。
    -   引数: `self`: `App`構造体自身への参照。
    -   戻り値: `Result<(), io::Error>`
    -   機能: 内部の音色データをJSONシリアライズし、指定されたファイルパス（例: `tone.json`）に書き込みます。ESCキーで終了する際に呼び出されると推測されます。

-   **`App::load_tone_data_from_json(&mut self)`**:
    -   役割: 起動時に指定されたJSONファイルからYM2151音色データを読み込み、アプリケーションの内部状態に設定します。
    -   引数: `self`: `App`構造体自身への可変参照。
    -   戻り値: `Result<(), io::Error>` (ファイルが見つからない、パースエラーなど)
    -   機能: JSONファイルを読み込み、YM2151音色データ構造にデシリアライズし、`App`の音色データを更新します。

-   **`App::play_tone_via_cat_mml_play(&self)`**:
    -   役割: 現在の内部音色データを`cat-mml-play`（外部プロセスまたはサーバー）に渡し、その音色で演奏させます。
    -   引数: `self`: `App`構造体自身への参照。
    -   戻り値: `Result<(), Box<dyn Error>>`
    -   機能: 内部音色データをJSON形式に変換し、`cat-mml-play`が提供するサーバー機能に送信するなどして、リアルタイムでの音色試聴を可能にします。

## 関数呼び出し階層ツリー
```
main()
└── run_app(terminal, app)
    ├── App::new() (アプリケーション初期化時)
    │   └── App::load_tone_data_from_json() (起動時にJSONファイルがあれば)
    ├── App::handle_event(event)
    │   ├── App::update_tone_parameter(change) (q/eキー押下時)
    │   │   └── App::play_tone_via_cat_mml_play() (パラメータ変更時、自動サーバー連携)
    │   └── App::save_tone_data_as_json() (ESCキー押下時)
    └── App::draw_ui(frame) (UI描画時)
```

---
Generated at: 2025-11-12 07:09:01 JST
