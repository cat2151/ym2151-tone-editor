Last updated: 2025-11-19

# Project Overview

## プロジェクト概要
- YM2151 FM音源チップの音色を、テキストベースのユーザーインターフェース（TUI）で直感的に編集できるエディタです。
- Rust言語で開発されており、Windows環境向けにリアルタイムでの音声フィードバック機能を提供します。
- 編集した音色データを即座に確認し、効率的な音色作成をサポートすることを目指しています。

## 技術スタック
- フロントエンド: 
    - `ratatui` (0.28): 高機能なテキストユーザーインターフェース（TUI）を構築するためのRustフレームワーク。ターミナル上でリッチなUI表示を実現します。
    - `crossterm` (0.28): ターミナルのクロスプラットフォーム操作を提供するライブラリ。キーボード入力、マウスイベント、画面制御などを処理します。
- 音楽・オーディオ: 
    - YM2151 (OPM) FM音源: ヤマハが開発したFM音源チップのパラメータを扱います。
    - `ym2151-log-play-server` ライブラリ: リアルタイム音声フィードバック機能を提供し、音色エディタから送信されたデータに基づいて音源を演奏します。名前付きパイプによるデータ送信を利用しています。
- ビルドツール: 
    - `cargo`: Rustの公式ビルドシステムおよびパッケージマネージャー。プロジェクトのビルド、依存関係の管理、実行などを行います。
- 言語機能: 
    - Rust (1.70 以降): 高い安全性とパフォーマンスを特徴とするシステムプログラミング言語。本プロジェクトの主要な開発言語です。

## ファイル階層ツリー
```
📄 .gitignore
📄 Cargo.lock
📄 Cargo.toml
📄 LICENSE
📖 README.ja.md
📖 README.md
📄 _config.yml
📁 generated-docs/
📁 issue-notes/
  📖 55.md
  📖 57.md
  📖 59.md
  📖 61.md
📁 src/
  📄 app.rs
  📄 file_ops.rs
  📄 main.rs
  📄 models.rs
  📄 register.rs
  📄 ui.rs
```

## ファイル詳細説明
- `README.ja.md`, `README.md`: プロジェクトの概要、機能、ビルド方法、操作方法などを日本語と英語で説明するドキュメントです。
- `.gitignore`: Gitのバージョン管理システムが無視するファイルやディレクトリを指定する設定ファイルです。
- `Cargo.lock`: `Cargo.toml`で定義された依存関係の具体的なバージョンを記録し、ビルドの再現性を保証します。
- `Cargo.toml`: Rustプロジェクトのメタデータ（プロジェクト名、バージョン、著者、依存クレートなど）を定義する設定ファイルです。
- `LICENSE`: プロジェクトのソフトウェアライセンス情報が記載されています。
- `_config.yml`: 主にGitHub Pagesなどの静的サイト生成ツールで使用される設定ファイルです。
- `generated-docs/`: 自動生成されたドキュメントや成果物を格納するためのディレクトリです。
- `issue-notes/`: 開発中に発生した課題や検討事項に関するメモが保存されているディレクトリです。
- `src/`: プロジェクトの主要なRustソースコードが格納されているディレクトリです。
    - `app.rs`: アプリケーションのメインロジック、状態管理、イベント処理などを担当するモジュールです。
    - `file_ops.rs`: 音色データのファイルへの保存や読み込みといったファイル操作に関連する機能を提供するモジュールです。
    - `main.rs`: プログラムのエントリポイントであり、アプリケーションの初期化やメインループの開始を行います。
    - `models.rs`: YM2151の音色データ構造や関連するデータモデルを定義するモジュールです。
    - `register.rs`: YM2151のレジスタに関する操作、値の範囲チェック、パラメータ変換ロジックなどを実装するモジュールです。
    - `ui.rs`: ターミナルユーザーインターフェース（TUI）の描画ロジックを担うモジュールで、`ratatui`クレートを使用して画面要素を配置・描画します。

## 関数詳細説明
- `main()` (src/main.rs):
    - 役割: プログラムのエントリポイント。
    - 引数: なし。
    - 戻り値: なし (または `Result<(), Box<dyn Error>>`)。
    - 機能: アプリケーションの初期設定、リアルタイムサーバーの準備 (`ensure_server_ready()`の呼び出し)、そしてメインアプリケーションロジック (`run_app()`の呼び出し) を実行します。
- `run_app()` (src/app.rs):
    - 役割: アプリケーションのメインイベントループを実行。
    - 引数: アプリケーションの状態やターミナルインスタンス。
    - 戻り値: なし (または `Result<(), Box<dyn Error>>`)。
    - 機能: ユーザーからの入力（キーボード、マウス）を処理し、それに基づいてアプリケーションの状態を更新し、UIを再描画するサイクルを管理します。
- `update()` (src/app.rs):
    - 役割: アプリケーションの状態を更新。
    - 引数: 現在のアプリケーション状態、ユーザー入力イベント。
    - 戻り値: 更新されたアプリケーション状態。
    - 機能: ユーザーのキー入力やマウス操作に応じて、カーソルの移動、YM2151パラメータの値の増減、音色データのランダム設定、サーバーへの音色データ送信などを処理します。
- `ui()` (src/ui.rs):
    - 役割: ユーザーインターフェースの描画。
    - 引数: 描画対象となるターミナルフレーム、現在のアプリケーション状態。
    - 戻り値: なし。
    - 機能: `ratatui`ライブラリを使用して、YM2151の各パラメータ、カーソル、操作説明などをターミナル画面上に視覚的に表示します。
- `save_tone()` (src/file_ops.rs):
    - 役割: 現在の音色データをファイルに保存。
    - 引数: 保存する音色データ、ファイルパス。
    - 戻り値: 保存の成否を示す結果。
    - 機能: アプリケーション終了時や、特定の操作があった際に、編集中のYM2151音色データをJSON形式で指定されたファイルに書き込みます。
- `load_tone()` (src/file_ops.rs):
    - 役割: ファイルから音色データを読み込む。
    - 引数: ファイルパス。
    - 戻り値: 読み込まれた音色データ。
    - 機能: アプリケーション起動時に、前回保存された音色データ（JSON形式）をファイルから読み込み、エディタに反映させます。
- `ensure_server_ready()` (ym2151-log-play-serverライブラリ):
    - 役割: リアルタイム音声フィードバックサーバーの準備を自動的に行う。
    - 引数: なし。
    - 戻り値: サーバー準備の成否を示す結果。
    - 機能: サーバーが起動していない場合に自動でインストールし、起動して、音色データを受け取れる状態に準備します。
- `send_json()` (ym2151-log-play-serverライブラリ経由):
    - 役割: 編集中の音色データをリアルタイムサーバーに送信。
    - 引数: 送信する音色データ（JSON形式）。
    - 戻り値: 送信の成否を示す結果。
    - 機能: 名前付きパイプを通じて、編集したYM2151音色データをリアルタイム音声フィードバックサーバーに送り、即座にその音色での演奏を可能にします。

## 関数呼び出し階層ツリー
```
main() // プログラムのエントリポイント
├── ensure_server_ready() // アプリ起動時にリアルタイム音声フィードバックサーバーの準備を自動実行
└── run_app() // アプリケーションのメインループを開始
    ├── (イベント処理と状態更新のサイクル)
    │   ├── update() // ユーザー入力（キーボード、マウス）に応じてアプリケーション状態を更新
    │   │   ├── send_json() // 更新された音色データをリアルタイムでサーバーに送信し、音声フィードバックを生成
    │   │   └── save_tone() // アプリケーション終了時や明示的な操作で音色データをファイルに保存
    └── ui() // 現在のアプリケーション状態に基づいてターミナルUIを描画

---
Generated at: 2025-11-19 07:08:44 JST
