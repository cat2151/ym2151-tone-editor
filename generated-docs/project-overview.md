Last updated: 2025-12-03

# Project Overview

## プロジェクト概要
- YM2151 FM音源の音色パラメータをリアルタイムで編集できるターミナルUIエディタです。
- 直感的なキーボード・マウス操作とリアルタイム音声フィードバックで、音作りを支援します。
- Windows環境向けにRustで開発されており、シンプルかつ効率的な音色編集体験を提供します。

## 技術スタック
- フロントエンド:
    - **ratatui 0.28**: Rust製のターミナルUIフレームワークで、高度なテキストベースのユーザーインターフェースを構築するために使用されます。
    - **crossterm 0.28**: クロスプラットフォーム対応のターミナル操作ライブラリで、キー入力、マウスイベント、画面描画などを扱います。
- 音楽・オーディオ:
    - **ym2151-log-play-server**: リアルタイム音声フィードバックを実現するためのライブラリで、YM2151のレジスタ書き込みを処理し、オーディオをストリーミングします。
- 開発ツール:
    - **Rust 1.70 以降**: 高速かつ安全なアプリケーション開発を可能にするシステムプログラミング言語です。
- テスト:
    - **Rustの標準テストフレームワーク**: `cargo test` コマンドで実行されるユニットテストおよび統合テスト。
- ビルドツール:
    - **cargo**: Rustの公式パッケージマネージャー兼ビルドシステム。プロジェクトのビルド、依存関係管理、テスト実行などを担当します。
- 言語機能:
    - **Rust**: 所有権システムによるメモリ安全性、パターンマッチング、トレイトによる抽象化など、堅牢なアプリケーション開発をサポートする言語機能。
- 自動化・CI/CD:
    - **cargoコマンド**: `cargo build --release` など、`cargo`コマンドを通じてビルドおよびテストの自動化が可能です。
- 開発標準:
    - **_config.yml**: Jekyllなどの静的サイトジェネレータでドキュメントサイトを構築する際の設定ファイルです。
    - **.gitignore**: Gitバージョン管理システムが無視するファイルやディレクトリを指定し、開発環境の一貫性を保ちます。

## ファイル階層ツリー
```
📄 .gitignore
📄 Cargo.lock
📄 Cargo.toml
📄 LICENSE
📖 README.ja.md
📖 README.md
📄 _config.yml
📁 docs/
  📖 KEYBINDS.ja.md
📁 generated-docs/
🌐 googled947dc864c270e07.html
📁 issue-notes/
  📖 100.md
  📖 101.md
  📖 102.md
  📖 103.md
  📖 104.md
  📖 105.md
  📖 106.md
  📖 107.md
  📖 108.md
  📖 109.md
  📖 110.md
  📖 111.md
  📖 112.md
  📖 113.md
  📖 114.md
  📖 115.md
  📖 116.md
  📖 95.md
  📖 96.md
  📖 97.md
  📖 99.md
📁 src/
  📄 app.rs
  📄 app_init.rs
  📄 audio.rs
  📄 config.rs
  📄 file_ops.rs
  📄 main.rs
  📄 midi_conversion.rs
  📄 models.rs
  📄 register.rs
  📁 tests/
    📄 app_tests.rs
    📄 file_ops_tests.rs
    📄 midi_conversion_tests.rs
    📄 mod.rs
    📄 register_tests.rs
    📄 ui_tests.rs
    📄 verbose_logging_tests.rs
  📄 ui.rs
📁 tones/
  📁 general_midi/
    📊 000_AcousticGrand.json
    📊 tone_names.json
📄 ym2151-tone-editor.toml.example
```

## ファイル詳細説明
- **`.gitignore`**: Gitバージョン管理システムが無視するファイルやディレクトリを指定し、不要なファイルをリポジトリに含めないようにします。
- **`Cargo.lock`**: `Cargo.toml`で指定された依存関係の具体的なバージョンを記録し、プロジェクトのビルドの再現性を保証します。
- **`Cargo.toml`**: Rustプロジェクトの依存関係、メタデータ、ビルド設定を定義するマニフェストファイルです。
- **`LICENSE`**: プロジェクトのライセンス情報（著作権、利用条件など）が記載されています。
- **`README.ja.md`**: プロジェクトの概要、使い方、機能などを日本語で説明する主要なドキュメントです。
- **`README.md`**: プロジェクトの概要、使い方、機能などを英語で説明する主要なドキュメントです。
- **`_config.yml`**: Jekyllなどの静的サイトジェネレータでドキュメントサイトを構築する際の設定ファイルです。
- **`docs/KEYBINDS.ja.md`**: アプリケーションのキーバインド（操作方法）に関する日本語の説明ドキュメントです。
- **`googled947dc864c270e07.html`**: Googleサイトの所有権確認や認証に使用されるファイルです。
- **`issue-notes/`**: 開発中の課題や検討事項を記録したMarkdownファイル群が含まれるディレクトリです。
- **`src/app.rs`**: アプリケーションの主要なロジックと状態管理を定義します。UIの状態、音色パラメータの変更、イベント処理などを統括します。
- **`src/app_init.rs`**: アプリケーションの初期化ロジックを含みます。設定の読み込みや初期状態のセットアップなどを行います。
- **`src/audio.rs`**: YM2151のリアルタイム音声フィードバックに関連するロジックを担当します。`ym2151-log-play-server`ライブラリとの連携、レジスタ書き込みデータの送信などを扱います。
- **`src/config.rs`**: アプリケーションの設定（キーバインドなど）の読み込みと管理を行います。`ym2151-tone-editor.toml.example`のような設定ファイルと連携します。
- **`src/file_ops.rs`**: ファイルの読み書き操作を扱います。音色データの保存・ロード、設定ファイルの操作などに関連します。
- **`src/main.rs`**: プロジェクトのエントリポイントであり、アプリケーションの起動と基本的なイベントループを管理します。
- **`src/midi_conversion.rs`**: MIDI関連の処理、例えばノートナンバーから周波数情報への変換など、YM2151音源に関連するMIDIデータの解釈ロジックを含む可能性があります。
- **`src/models.rs`**: YM2151音色データ構造やアプリケーション内で使用される各種データモデルを定義します。例えば、`Parameters`構造体など。
- **`src/register.rs`**: YM2151のレジスタ操作に関連するロジックを扱います。音色パラメータを実際のYM2151レジスタ値に変換する機能など。
- **`src/tests/`**: 各モジュールの単体テストや統合テストが含まれるディレクトリです。
- **`src/ui.rs`**: `ratatui` を使用してターミナルUIの描画ロジックを定義します。画面上の各要素（パラメータ表示、カーソル、値など）のレイアウトとレンダリングを担当します。
- **`tones/general_midi/000_AcousticGrand.json`**: General MIDIの「アコースティックグランドピアノ」に相当するYM2151音色データが定義されており、音色保存フォーマットの検討内容を反映しています。
- **`tones/general_midi/tone_names.json`**: 音色の名前リストやマッピングに関するデータを含む可能性があります。
- **`ym2151-tone-editor.toml.example`**: アプリケーションの設定ファイル（例: キーバインド）のサンプルです。ユーザーがこれをコピーしてカスタマイズできます。

## 関数詳細説明
具体的な関数情報は提供されていないため、主要なモジュールが担うであろう役割に基づいて一般的な説明を行います。

- **`app`モジュール内で定義される主要な関数**:
    - **`new()`**: アプリケーションの初期状態を構築します。
        - 役割: アプリケーションの状態オブジェクトを初期化します。
        - 引数: なし (または初期設定に関連する引数)
        - 戻り値: `App`構造体のインスタンス。
    - **`run()`**: アプリケーションのメインループを実行し、イベント処理とUI更新を行います。
        - 役割: アプリケーションの実行フローを制御し、ユーザー入力の待機、状態の更新、UIの再描画を繰り返します。
        - 引数: なし (またはターミナル関連の設定)
        - 戻り値: `Result<(), Box<dyn Error>>` (エラーハンドリングのための型)。
    - **`handle_event(event)`**: ユーザー入力（キー、マウス）などのイベントを処理し、アプリケーションの状態を更新します。
        - 役割: 特定のイベントタイプ（キー押下、マウス操作など）に応じて、音色パラメータの変更やアプリケーションの状態遷移をトリガーします。
        - 引数: `event` (ユーザー入力イベントの構造体)。
        - 戻り値: `bool` (アプリケーションを終了するかどうか) または `AppEvent` (処理結果)。
    - **`update_value(parameter_id, value)`**: 指定された音色パラメータの値を変更します。
        - 役割: 現在選択されているYM2151音色パラメータの値を増減させます。
        - 引数: `parameter_id` (対象のパラメータを識別するID), `value` (変更量または設定値)。
        - 戻り値: なし。
    - **`preview_tone()`**: 現在の音色でYM2151に音を鳴らすコマンドを送信します。
        - 役割: 編集中の音色をリアルタイムで試聴するために、YM2151サウンドサーバーに再生指示を送ります。
        - 引数: なし。
        - 戻り値: なし。
    - **`save_state()`**: アプリケーションの状態や音色データをファイルに保存します。
        - 役割: アプリケーション終了時などに、現在の音色データや設定を永続化します。
        - 引数: なし。
        - 戻り値: `Result<(), Box<dyn Error>>`。
    - **`load_state()`**: ファイルからアプリケーションの状態や音色データをロードします。
        - 役割: アプリケーション起動時に、前回保存された音色データや設定を読み込み、編集を再開できるようにします。
        - 引数: なし。
        - 戻り値: `Result<App, Box<dyn Error>>`。

- **`audio`モジュール内で定義される主要な関数**:
    - **`ensure_server_ready()`**: `ym2151-log-play-server`が動作していることを確認し、必要であれば起動します。
        - 役割: 音声フィードバックサーバーが利用可能な状態であることを保証します。
        - 引数: なし。
        - 戻り値: `Result<(), Box<dyn Error>>`。
    - **`send_register_data(address, value)`**: 指定されたYM2151レジスタに値を書き込むコマンドをサーバーに送信します。
        - 役割: YM2151の特定レジスタに直接書き込むことで、音色パラメータの変更をリアルタイムに反映させます（インタラクティブモード）。
        - 引数: `address` (レジスタのアドレス), `value` (書き込む値)。
        - 戻り値: なし。
    - **`send_full_tone_data(tone_data)`**: 全音色データをJSON形式でサーバーに送信します。
        - 役割: 音色の全パラメータをJSON形式でサーバーに送信し、音を再生させます（レガシーモード）。
        - 引数: `tone_data` (完全な音色データ構造)。
        - 戻り値: なし。

- **`config`モジュール内で定義される主要な関数**:
    - **`load_config()`**: 設定ファイル (`.toml`形式など) から設定を読み込みます。
        - 役割: アプリケーション起動時にキーバインドやその他のユーザー設定をロードします。
        - 引数: なし (または設定ファイルのパス)。
        - 戻り値: `Config`構造体のインスタンス。
    - **`get_keybind(action)`**: 特定のアクションに割り当てられたキーバインドを取得します。
        - 役割: 特定の操作（例: 値の増加）に対応するキー入力を検索します。
        - 引数: `action` (操作を識別する列挙型)。
        - 戻り値: 割り当てられたキーのリスト。

- **`file_ops`モジュール内で定義される主要な関数**:
    - **`read_json_file(path)`**: 指定されたパスからJSONファイルを読み込みます。
        - 役割: 音色データや設定ファイルなど、JSON形式のデータをファイルから読み込みます。
        - 引数: `path` (ファイルパス)。
        - 戻り値: 読み込んだJSONデータ。
    - **`write_json_file(path, data)`**: 指定されたパスにデータをJSON形式で書き込みます。
        - 役割: 音色データや設定データなど、JSON形式のデータをファイルに書き込みます。
        - 引数: `path` (ファイルパス), `data` (書き込むデータ)。
        - 戻り値: `Result<(), Box<dyn Error>>`。

- **`main`モジュール内で定義される主要な関数**:
    - **`main()`**: プログラムのエントリポイント。アプリケーションのセットアップ、実行、クリーンアップ処理を呼び出します。
        - 役割: プログラムの実行を開始し、`App::run()`などの主要な関数を呼び出します。
        - 引数: なし。
        - 戻り値: `Result<(), Box<dyn Error>>`。

- **`midi_conversion`モジュール内で定義される主要な関数**:
    - **`note_number_to_frequency(note_number)`**: MIDIノートナンバーをYM2151が使用する周波数情報に変換します。
        - 役割: MIDIキーボードからの入力や音色データ内のノート情報をYM2151のレジスタ設定に適した周波数値に変換します。
        - 引数: `note_number` (MIDIノートナンバー、0-127)。
        - 戻り値: YM2151の周波数設定値。

- **`models`モジュール内で定義される主要な関数**:
    - **`ToneParameters::new()`**: 新しい音色パラメータ構造体を作成します。
        - 役割: YM2151の音色パラメータを格納するデータ構造を初期化します。
        - 引数: なし (またはデフォルト値)。
        - 戻り値: `ToneParameters`構造体のインスタンス。
    - **`ToneParameters::to_register_values()`**: 音色パラメータをYM2151レジスタ値の形式に変換します。
        - 役割: 編集中の音色パラメータの論理値を、実際のYM2151レジスタ書き込み用の物理値のペアに変換します。
        - 引数: `&self` (自身のインスタンス)。
        - 戻り値: レジスタアドレスと値のペアのリスト。

- **`register`モジュール内で定義される主要な関数**:
    - **`parameter_to_register(parameter_type, value)`**: 特定の音色パラメータ値に対応するYM2151レジスタアドレスと値を計算します。
        - 役割: ユーザーが編集する抽象的なパラメータ（例: TL、AR）を、YM2151の具体的なレジスタアドレスとデータ値にマッピングします。
        - 引数: `parameter_type` (パラメータの種類), `value` (パラメータの値)。
        - 戻り値: レジスタアドレスと値のペア。

- **`ui`モジュール内で定義される主要な関数**:
    - **`draw_ui(frame, app_state)`**: `ratatui`のフレームに現在のアプリケーション状態に基づいたUI要素を描画します。
        - 役割: アプリケーションの現在の状態（音色パラメータ、カーソル位置など）をターミナル画面に表示します。
        - 引数: `frame` (`ratatui::Frame`オブジェクト), `app_state` (アプリケーションの現在の状態)。
        - 戻り値: なし。
    - **`draw_parameter_table(frame, parameters)`**: YM2151のパラメータテーブルを描画します。
        - 役割: DT, MUL, TLなどのYM2151の音色パラメータをグリッド形式で画面に表示します。
        - 引数: `frame`, `parameters` (表示する音色パラメータ)。
        - 戻り値: なし。
    - **`draw_help_text(frame)`**: ヘルプメッセージやキーバインドのヒントを描画します。
        - 役割: ユーザーが操作に迷った際に参考となる情報（例: ショートカットキー）を画面のフッターなどに表示します。
        - 引数: `frame`。
        - 戻り値: なし。

## 関数呼び出し階層ツリー
```
関数呼び出し階層を分析できませんでした。

---
Generated at: 2025-12-03 07:08:49 JST
