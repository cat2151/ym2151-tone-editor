Last updated: 2025-11-20

# Project Overview

## プロジェクト概要
- YM2151 FM音源の音色を編集するための、Windows向けのテキストユーザーインターフェース（TUI）エディタです。
- 直感的な操作とリアルタイムの音声フィードバックを通じて、手軽に音色パラメータの調整を試すことができます。
- シンプルな設計で素早い起動と応答性を重視し、作成した音色はファイルとして保存・管理されます。

## 技術スタック
- フロントエンド: `ratatui` (バージョン0.28) を使用したテキストユーザーインターフェース（TUI）フレームワークで、ターミナル上で視覚的な音色パラメータ編集画面を提供します。`crossterm` (バージョン0.28) がクロスプラットフォームのターミナル操作（キー入力、マウスイベントなど）を可能にしています。
- 音楽・オーディオ: YM2151（OPM）FM音源のエミュレーションを基盤とし、`ym2151-log-play-server`ライブラリを介してリアルタイムでの音声フィードバックを実現します。サーバーのセットアップと起動は自動化されています。
- 開発ツール: Rustの標準ビルドツール兼パッケージマネージャである`cargo`を使用しており、プロジェクトのビルド、実行、テストを管理します。
- テスト: `src/tests/`ディレクトリ配下でRustの組み込みテストフレームワークを利用し、アプリケーションの各モジュールの機能検証を行っています。
- ビルドツール: Rustの`cargo build --release`コマンドにより、最適化された実行可能なバイナリを生成します。
- 言語機能: Rust 1.70 以降のバージョンで開発されており、Rustのモダンな言語機能と強力な型システムを活用しています。
- 自動化・CI/CD: `ym2151-log-play-server`の`ensure_server_ready()`関数により、リアルタイム音声フィードバックサーバーのインストール、起動、準備状況チェックが自動的に行われます。
- 開発標準: Rustの慣習に従い、`Cargo.toml`で依存関係やプロジェクト設定を管理しています。

## ファイル階層ツリー
```
📄 .gitignore
📄 Cargo.lock
📄 Cargo.toml
📄 LICENSE
📖 README.ja.md
📖 README.md
📄 _config.yml
📁 generated-docs/
📁 issue-notes/
  📖 55.md
  📖 57.md
  📖 59.md
  📖 61.md
  📖 62.md
  📖 65.md
  📖 66.md
  📖 68.md
  📖 70.md
  📖 72.md
  📖 75.md
📁 src/
  📄 app.rs
  📄 audio.rs
  📄 file_ops.rs
  📄 main.rs
  📄 midi_conversion.rs
  📄 models.rs
  📄 register.rs
  📁 tests/
    📄 app_tests.rs
    📄 file_ops_tests.rs
    📄 midi_conversion_tests.rs
    📄 mod.rs
    📄 register_tests.rs
    📄 ui_tests.rs
    📄 verbose_logging_tests.rs
  📄 ui.rs
📁 tones/
  📁 general_midi/
    📊 000_AcousticGrand.json
```

## ファイル詳細説明
- `.gitignore`: Gitのバージョン管理から除外するファイルやディレクトリを指定します。
- `Cargo.lock`: プロジェクトの依存関係の正確なバージョンを記録し、再現可能なビルドを保証します。
- `Cargo.toml`: Rustプロジェクトの設定ファイルで、プロジェクト名、バージョン、依存クレートなどが定義されています。
- `LICENSE`: プロジェクトのライセンス情報が記載されています。
- `README.ja.md`: プロジェクトの日本語版説明書です。
- `README.md`: プロジェクトの英語版説明書です。
- `_config.yml`: GitHub Pagesなどの静的サイトジェネレータの設定ファイルである可能性があります。
- `generated-docs/`: 自動生成されたドキュメントを格納するディレクトリです。
- `issue-notes/`: 開発中のイシューに関するメモや詳細情報が格納されているディレクトリです。（※来訪者向けには詳細説明は割愛）
- `src/app.rs`: アプリケーションの主要なロジックを担い、TUIの状態管理、イベント処理、音色パラメータの操作、音声フィードバックのトリガーなどを扱います。
- `src/audio.rs`: YM2151音源の音声フィードバックに関連するロジックが含まれます。`ym2151-log-play-server`との連携、データ送信モードの切り替え（レガシー/インタラクティブ）、データの送信処理を行います。
- `src/file_ops.rs`: 音色データの保存と読み込みに関するファイル操作ロジックを提供します。編集後の音色をJSON形式で永続化し、次回起動時に読み込む機能を提供します。
- `src/main.rs`: アプリケーションのエントリーポイントです。初期設定、TUIの初期化、イベントループの開始、アプリケーション終了時のクリーンアップなどを担当します。
- `src/midi_conversion.rs`: MIDI関連の変換ロジックを扱います。音色データの`note_number`や`mml`（Music Macro Language）の解釈と、YM2151レジスタ値との関連付けなどが含まれる可能性があります。
- `src/models.rs`: アプリケーション内で使用される主要なデータ構造（例：YM2151音色パラメータ、TUIの描画状態、キーバインド設定など）を定義します。
- `src/register.rs`: YM2151のレジスタマップとそれに関連する操作ロジックを管理します。各パラメータの有効範囲のチェックや、レジスタアドレスへのマッピングなどを行います。
- `src/tests/`: 各モジュールの単体テストや統合テストを記述するディレクトリです。
    - `src/tests/app_tests.rs`: `app.rs`モジュールのテストコードです。
    - `src/tests/file_ops_tests.rs`: `file_ops.rs`モジュールのテストコードです。
    - `src/tests/midi_conversion_tests.rs`: `midi_conversion.rs`モジュールのテストコードです。
    - `src/tests/mod.rs`: `tests`モジュールのルートファイルで、他のテストファイルをまとめます。
    - `src/tests/register_tests.rs`: `register.rs`モジュールのテストコードです。
    - `src/tests/ui_tests.rs`: `ui.rs`モジュールのテストコードです。
    - `src/tests/verbose_logging_tests.rs`: 詳細なロギング機能に関するテストコードです。
- `src/ui.rs`: テキストユーザーインターフェース (TUI) の描画ロジックを担当します。`ratatui`クレートを使用して、音色パラメータの表示、カーソルのレンダリング、各種UI要素の配置を行います。
- `tones/general_midi/`: General MIDI互換の音色データが格納されるディレクトリです。
    - `tones/general_midi/000_AcousticGrand.json`: サンプルとして提供される、アコースティックグランドピアノのYM2151音色データファイルです。

## 関数詳細説明
- `main()`: アプリケーションのエントリーポイントです。プログラムの初期設定、TUIの初期化、主要なイベントループの開始、および終了処理を行います。
- `run_app()`: TUIアプリケーションのメインロジックを実行する関数です。キー入力やマウスイベントの処理、UIの更新、音色データの保存などの中心的なタスクを管理します。
- `handle_input()`: ユーザーからのキーボード入力やマウスイベントを受け取り、それに応じてアプリケーションの状態を更新します。カーソル移動、パラメータ値の増減、モード切り替えなどを制御します。
- `update_ui()`: 現在のアプリケーションの状態に基づいて、`ratatui`フレームワークを用いてターミナル上にUIを再描画します。パラメータ値、カーソル位置、再生状態などを視覚的に表現します。
- `play_tone()`: 現在編集中のYM2151音色を再生します。`audio`モジュールを介して、サーバーに音色データを送信し、リアルタイムでの音声フィードバックを可能にします。
- `save_tone()`: 現在のYM2151音色データをJSON形式でファイルに保存します。アプリケーション終了時や手動での保存操作で呼び出されます。
- `load_tone()`: アプリケーション起動時に、以前保存されたYM2151音色データをJSONファイルから読み込み、エディタに反映させます。
- `ensure_server_ready()`: `ym2151-log-play-server`が稼働しているかを確認し、必要であれば自動的にサーバーをセットアップおよび起動します。リアルタイム音声フィードバックの基盤を確立します。
- `send_json()`: レガシーモードにおいて、完全な音色データをJSON形式で`ym2151-log-play-server`に送信します。パラメータ変更のたびに全データが送られます。
- `start_interactive()`: インタラクティブモードを開始し、サーバー上で継続的なオーディオストリーミングを開始させます。
- `write_register()`: インタラクティブモードにおいて、変更されたYM2151レジスタのみをサーバーに書き込みコマンドとして送信します。これにより効率的な音声フィードバックが実現します。
- `stop_interactive()`: インタラクティブモードを終了し、サーバー上でのオーディオストリーミングを停止させます。
- `get_parameter_range()`: YM2151の各パラメータ（DT, MUL, TLなど）の有効な最小値と最大値を取得します。引数：パラメータの種類、戻り値：範囲情報。
- `update_parameter_value()`: 指定されたカーソル位置のパラメータ値を、増減、最大値/最小値設定、またはランダム値設定に基づいて更新します。引数：パラメータの種類、操作の種類、戻り値：更新後の値。

## 関数呼び出し階層ツリー
```
提供された情報から呼び出し階層を生成することはできませんでした。

---
Generated at: 2025-11-20 07:08:34 JST
