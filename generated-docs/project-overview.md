Last updated: 2025-11-17

# Project Overview

## プロジェクト概要
- YM2151 FM音源の音色パラメータを直感的に編集できるターミナルUIエディタです。
- カーソル移動やキー操作でパラメータを調整し、リアルタイムで音色変化を確認できます。
- Windows環境で動作し、音色作成の効率化とYM2151音源の探求を支援します。

## 技術スタック
- フロントエンド: **ratatui** (0.28) - Rust製のTUI (Text User Interface) フレームワークで、ターミナル上でリッチなユーザーインターフェースを構築するために使用されます。
- フロントエンド: **crossterm** (0.28) - クロスプラットフォーム対応のターミナル操作ライブラリで、キーボード入力、マウスイベント、画面描画などの低レベルなターミナル制御を扱います。
- 音楽・オーディオ: **ym2151-log-play-server** (ライブラリ) - YM2151音源の演奏サーバーを管理し、音色データをリアルタイムで送信してオーディオフィードバックを得るためのRustライブラリです。Windowsの名前付きパイプを介して通信します。
- 開発ツール: **Rust** (1.70以降) - プロジェクトの主要なプログラミング言語です。安全性、速度、並行性を重視したシステムプログラミング言語として使用されています。
- ビルドツール: **Cargo** - Rustの公式パッケージマネージャー兼ビルドシステムです。プロジェクトの依存関係の管理、ビルド、テスト、ドキュメント生成などを担当します。
- 言語機能: **Rustの強力な型システムと安全性** - コンパイル時に多くのバグを検出できる厳格な型システムと、メモリ安全性を保証する所有権システムにより、堅牢なアプリケーション開発を実現します。

## ファイル階層ツリー
```
📄 .gitignore
📄 Cargo.lock
📄 Cargo.toml
📄 LICENSE
📖 NOTE_ON_VISUALIZATION.md
📖 README.md
📄 _config.yml
📁 generated-docs/
📁 issue-notes/
  📖 10.md
  📖 11.md
  📖 14.md
  📖 16.md
  📖 18.md
  📖 20.md
  📖 21.md
  📖 22.md
  📖 23.md
  📖 24.md
  📖 30.md
  📖 32.md
  📖 34.md
  📖 36.md
  📖 38.md
  📖 40.md
  📖 41.md
  📖 42.md
📁 src/
  📄 app.rs
  📄 file_ops.rs
  📄 main.rs
  📄 models.rs
  📄 register.rs
  📄 ui.rs
```

## ファイル詳細説明
-   **`.gitignore`**: Gitのバージョン管理から除外するファイルやディレクトリを指定します。
-   **`Cargo.lock`**: プロジェクトが依存するクレートの正確なバージョンとその依存関係ツリーを記録し、ビルドの一貫性を保証します。
-   **`Cargo.toml`**: Rustプロジェクトのマニフェストファイルです。プロジェクト名、バージョン、依存関係、ビルド設定などを定義します。
-   **`LICENSE`**: プロジェクトのライセンス情報が記載されています。
-   **`NOTE_ON_VISUALIZATION.md`**: 視覚化に関する特定のノートやアイデアが記述されている可能性のあるドキュメントです。
-   **`README.md`**: プロジェクトの概要、セットアップ方法、使用方法、機能など、基本的な情報を提供します。
-   **`_config.yml`**: Jekyllなどの静的サイトジェネレータで使用される設定ファイルである可能性があります。
-   **`generated-docs/`**: 自動生成されたドキュメントやレポートが格納されるディレクトリです。
-   **`issue-notes/`**: 開発中に発生した課題や解決策、議論などを記録したノートが格納されているディレクトリです。
-   **`src/app.rs`**: アプリケーションの主要なロジック、状態管理、イベント処理を担当するモジュールです。UIイベントを受けてモデルの状態を更新し、オーディオサーバーとの連携を調整します。
-   **`src/file_ops.rs`**: 音色データをJSON形式でファイルに保存したり、ファイルから読み込んだりするI/O操作を扱うモジュールです。
-   **`src/main.rs`**: プロジェクトのエントリポイントです。アプリケーションの初期化、ターミナルUIのセットアップ、メインイベントループの開始などを担当します。
-   **`src/models.rs`**: YM2151音色パラメータのデータ構造や、アプリケーションで扱うその他のデータモデルを定義するモジュールです。
-   **`src/register.rs`**: YM2151のレジスタマップに基づいたパラメータの変換、値の範囲チェック、内部データ形式とYM2151-log-play-server形式間のマッピングなどを処理するモジュールです。
-   **`src/ui.rs`**: `ratatui`クレートを使用して、ターミナル画面上に音色パラメータのグリッド、カーソル、その他のUI要素を描画するロジックを管理するモジュールです。

## 関数詳細説明
-   **`main` (src/main.rs)**
    -   役割: アプリケーションの起動とメインループの実行。ターミナルを初期化し、`App`構造体を構築してイベント処理を開始します。
    -   引数: なし
    -   戻り値: `Result<(), Box<dyn Error>>` (アプリケーションの実行結果、エラーが発生した場合はエラーオブジェクト)
    -   機能: `crossterm`でターミナルをセットアップし、`App::run_event_loop`を呼び出してアプリケーションのメイン処理を開始します。
-   **`App::new` (src/app.rs)**
    -   役割: アプリケーションの状態を保持する`App`構造体のインスタンスを初期化します。
    -   引数: なし (または初期音色データなど)
    -   戻り値: `App` (初期化されたアプリケーションの状態)
    -   機能: 編集中の音色データ、カーソル位置、UIモードなど、アプリケーションが追跡する必要のあるすべての状態を設定します。
-   **`App::run_event_loop` (src/app.rs)**
    -   役割: アプリケーションのメインイベントループを実行し、UIイベントの処理、状態の更新、UIの描画を調整します。
    -   引数: なし
    -   戻り値: `Result<(), Box<dyn Error>>`
    -   機能: キーボードやマウスイベントを待機し、イベントに応じて`App`の状態を更新し、`ui`モジュールに描画を指示し、必要に応じて`ym2151-log-play-server`との通信を行います。
-   **`App::handle_key_event` (src/app.rs)**
    -   役割: キーボード入力イベントを処理し、カーソルの移動、パラメータ値の増減、アプリケーションの終了などを行います。
    -   引数: `KeyEvent` (crosstermのキーイベント情報)
    -   戻り値: `Result<bool, Box<dyn Error>>` (処理が終了するかどうかを示すブール値)
    -   機能: `hjkl`、`wasd`によるカーソル移動、`q`/`e`による値変更、`ESC`による終了といったユーザー操作に応じたロジックを実装します。
-   **`App::update_tone_and_send` (src/app.rs, 推測)**
    -   役割: 内部の音色データを更新し、その変更を`ym2151-log-play-server`に送信してリアルタイムで音を鳴らします。
    -   引数: 更新されたパラメータ値など
    -   戻り値: `Result<(), Box<dyn Error>>`
    -   機能: `register`モジュールを利用して値をYM2151形式に変換し、`ym2151-log-play-server`ライブラリの`send_json`関数を呼び出して名前付きパイプ経由でデータを送信します。
-   **`save_tone_data_to_json` (src/file_ops.rs)**
    -   役割: 現在編集中の音色データをJSON形式でファイルに保存します。
    -   引数: `&ToneData` (保存する音色データ), `&Path` (保存先のファイルパス)
    -   戻り値: `Result<(), Box<dyn Error>>`
    -   機能: 音色データをシリアライズし、指定されたパスにJSONファイルとして書き出します。
-   **`load_tone_data_from_json` (src/file_ops.rs)**
    -   役割: 指定されたJSONファイルから音色データを読み込み、アプリケーションの内部形式に変換します。
    -   引数: `&Path` (読み込むJSONファイルのパス)
    -   戻り値: `Result<ToneData, Box<dyn Error>>` (読み込まれた音色データ)
    -   機能: JSONファイルを読み込み、デシリアライズして`ToneData`構造体として返します。
-   **`convert_to_ym2151_log_format` (src/register.rs, 推測)**
    -   役割: アプリケーションの内部音色データ表現を、`ym2151-log-play-server`が期待するYM2151レジスタログ形式に変換します。
    -   引数: `&ToneData` (内部音色データ)
    -   戻り値: `Ym2151LogFormat` (変換されたYM2151ログデータ)
    -   機能: 各オペレータおよびチャンネルのパラメータ値をYM2151のハードウェアレジスタ値にマッピングします。
-   **`ui::draw` (src/ui.rs)**
    -   役割: `ratatui`の描画エンジンを使用して、アプリケーションの現在の状態に基づいてターミナルUI全体を描画します。
    -   引数: `&mut Frame` (ratatuiの描画フレーム), `&App` (アプリケーションの現在の状態)
    -   戻り値: なし
    -   機能: 音色パラメータのグリッド、カーソル、ステータスバーなどの各UIコンポーネントを描画します。
-   **`ym2151_log_play_server::ensure_server_ready` (外部ライブラリ)**
    -   役割: `ym2151-log-play-server`が動作していることを確認し、必要に応じてインストールまたは起動します。
    -   引数: なし
    -   戻り値: `Result<(), Box<dyn Error>>`
    -   機能: サーバーの存在確認、自動ダウンロード、起動、および名前付きパイプの準備を行います。
-   **`ym2151_log_play_server::send_json` (外部ライブラリ)**
    -   役割: 音色データをJSON形式で`ym2151-log-play-server`に送信し、リアルタイムで音源を更新します。
    -   引数: `&str` (JSON形式の音色データ文字列)
    -   戻り値: `Result<(), Box<dyn Error>>`
    -   機能: 内部で名前付きパイプ通信を管理し、データサイズに応じて最適な転送方法（直接送信またはファイル経由）を自動選択します。

## 関数呼び出し階層ツリー
```
main (src/main.rs)
├── App::new() (src/app.rs)
├── ym2151_log_play_server::ensure_server_ready()
└── App::run_event_loop() (src/app.rs)
    ├── App::handle_key_event() (src/app.rs)
    │   ├── App::update_tone_and_send() (src/app.rs, 推測)
    │   │   ├── src/register.rs::convert_to_ym2151_log_format() (推測)
    │   │   └── ym2151_log_play_server::send_json()
    │   └── src/file_ops.rs::save_tone_data_to_json() (ESCキー押下時)
    ├── src/ui.rs::draw()
    └── (必要に応じて) src/file_ops.rs::load_tone_data_from_json() (起動時、App::newから呼び出される可能性あり)

---
Generated at: 2025-11-17 07:08:12 JST
