# issue serverが常駐していないときに起動すると表示崩れしてuserが混乱する #113
[issues #113](https://github.com/cat2151/ym2151-tone-editor/issues/113)

# 事象
- 上記条件で実行するとこうなる：
    - TUIが表示される
    - サーバーが起動していない旨が表示される（TUIが表示崩れ）
    - 「Starting server...」が表示される（TUIが表示崩れ）
    - 音色送信の「Sending JSON directly to server...」～「Operation completed.」が表示される（TUIが表示崩れ）

# ほしいもの
- 上記条件で実行するとこうなる：
    - TUI表示前に、
        - サーバーが起動していない旨が表示される
        - cat-play-mmlが未インストールの場合
            - `cargo install --git～` が実行される
        - `cat-play-mml --server`が実行される
    - TUIが表示される
    - 音色が送信される

# code調査
- 問い、ensureは、tone editorから、どう呼び出している？
    - main.rsで、enable_raw_mode の前に呼び出している
    - ※ensureとは、`ym2151_log_play_server::client::ensure_server_ready`のこと
- 問い、ensureの中身はどんな処理？
    - ライブラリのclient側の関数をシンプルに呼び出し
        - ライブラリが、引数 `server` で呼び出している
- 問い、cat-play-mml側はensureを使っている？
    - いいえ。try_play_or_start_server を自前で実装している
- 問い、何が起きている？
    - cat-play-mmlには`--server`がないため、
    - `server`をMMLと解釈し、
    - try_play_or_start_server にて、server存在チェックを行い、serverを起動し、`e r e r`（意訳）を演奏する
    - cat-play-mmlは、MML演奏モード時は、各種printを行う
    - このprintによってTUIが表示崩れする

# 分析
- 問い、serverライブラリの修正をして、ensure時、引数が`ym2151-log-play-server`以外なら、`server`のかわりに`--server`とする？
    - はい。
- 問い、ym2151-log-play-serverは、`--server`も受け付けるとよい？
    - いいえ、既に現状のコマンドラインがわかりやすくまとまっている。これを崩してムダに複雑にするのはデメリットのほうが大きい。
- 問い、cat-play-mmlは、`server`サブコマンド、`shutdown`サブコマンドも、受け付けるとよい？
    - いいえ
        - 根拠、既に現状のコマンドラインがシンプルに提示されている。これを崩してムダに複雑にするのはデメリットのほうが大きい。
```powershell
cat-play-mml
Error: INPUT is required unless using --server, --stop, or --shutdown
```
- 問い、ym2151-log-play-serverとcat-play-mmlで、`server`サブコマンドと、`--server`オプションとがブレているのはなぜ？
    - それぞれの用途が違うため。
    - 前者はライブラリだし、serverモードとclientモードなので、サブコマンドが適切。
    - 後者はplayerとしてMML文字列を受け取る優先度が高い。そのためサブコマンドは禁止し、オプションのみを受け取る仕様が適切。
- 問い、cat-play-mmlもensureを採用する？
    - [x] はい。シンプル優先。別issueで取り扱う考え。→ cat-play-mml issue 31

# close条件
- serverライブラリが前述の修正をされること
- serverが常駐していないときに起動しても、表示崩れしなくなること

# 状況
- 上記確認した

# closeとする
