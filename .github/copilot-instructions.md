# YM2151 Tone Editor - AI コーディング指示書

## プロジェクト概要
YM2151（OPM）FM合成パラメータを編集するための専用Rustターミナル UI。リアルタイム音声フィードバック機能付き。低レベルチッププログラミングとユーザーフレンドリーな音響設計を橋渡しします。

## アーキテクチャ & 核となる概念

### YM2151レジスタマッピングシステム
アプリケーションはユーザーフレンドリーなパラメータと実際のYM2151チップレジスタ間の双方向変換を実装：
- **グリッドモデル**: 5行×11列でオペレータ（OP1-OP4）＋チャンネル設定を表現
- **レジスタエンコーディング**: `to_ym2151_events()`などの関数がパラメータをハードウェアレジスタ（0x40-0xFF範囲）にパック
- **イベントデコーディング**: `events_to_tone_data()`がJSONログを編集可能パラメータに変換
- **ビット操作**: 各パラメータはYM2151の特定ビット範囲を尊重（例：DT=3ビット、MUL=4ビット）

### リアルタイム音声統合
**Windows限定ライブプレビュー**: 値変更時に`call_cat_play_mml()`がトリガーされ、名前付きパイプ経由で`ym2151-log-play-server`にJSONを送信して即座に音声フィードバック。パラメータ編集と音声出力間の瞬時接続を実現。

### デュアルUIレイアウトシステム
TUIは2つの異なるパラメータセットを処理：
- **オペレータ行（0-3）**: 各11パラメータ（DT、MUL、TL、KS、AR、D1R、D1L、D2R、RR、DT2、AMS）
- **チャンネル行（4）**: 6パラメータ（ALG、FB、OP1-mask、OP2-mask、OP3-mask、OP4-mask）
カーソルナビゲーションは垂直移動時にこれらのレイアウト間で自動制限。

## 主要データ構造 & 定数

### パラメータ定義
```rust
const PARAM_NAMES: [&str; GRID_WIDTH] = ["DT", "MUL", "TL", ...]; // オペレータパラメータ
const CH_PARAM_NAMES: [&str; CH_PARAM_COUNT] = ["ALG", "FB", "OP1", ...]; // チャンネルパラメータ
const PARAM_MAX: [u8; GRID_WIDTH] = [7, 15, 99, 3, 31, ...]; // ハードウェア制限
```

### JSONイベント形式
プロジェクトは`ym2151-log-play-server`統合用の特定イベントログ構造を使用：
```rust
struct Ym2151Event { time: u32, addr: String, data: String }
```

## 開発ワークフロー

### テスト戦略
以下に焦点を当てた包括的テストスイートを実行：
- **レジスタマッピング往復**: `cargo test events_to_tone_data`
- **JSONシリアライゼーション**: `cargo test json_serialization`
- **パラメータ境界検証**: `cargo test increase_decrease_value`
- **アルゴリズム図レンダリング**: `cargo test get_algorithm_diagram`

### リアルタイムテスト
エディタは起動時に`ym2151_log_play_server::client::ensure_server_ready()`を呼び出し、サーバーの自動セットアップと起動を実現。`send_json`を使用して音色データを送信することで、開発中のライブ音声フィードバックを有効化。`send_json`はデータサイズに応じて自動的に最適な送信方法（直接送信またはファイル経由）を選択し、キーリピート中でも音が鳴ることを検証できる。

### ファイル管理パターン
アプリは起動時に最新の`ym2151_tone_*.json`ファイルを自動読込し、終了時にタイムスタンプ付きファイルを生成。編集した音色の自然なバージョン履歴を作成。

## FM合成ドメイン知識

### アルゴリズム可視化
`get_algorithm_diagram()`関数は各ALG値（0-7）のオペレータ接続を示すASCII図を描画。これらの可視化はユーザーがオペレータ相互作用を理解するために重要。

### パラメータ関係
- **モジュレータ vs キャリア**: 役割はアルゴリズム設定に依存 - 同じオペレータがモジュレータまたはキャリアになる
- **TL（トータルレベル）**: オペレータ出力音量制御 - モジュレーション深度とキャリア音量の両方に影響
- **スロットマスク**: アルゴリズムルーティングとは独立して個別オペレータを有効/無効化

## プロジェクト固有パターン

### 条件付きコンパイル
Windows限定音声機能は`ym2151-log-play-server`統合周辺で`#[cfg(windows)]`ガードを使用。

## 重要統合ポイント
- **ym2151-log-play-server**: 名前付きパイプ経由のWindows音声再生用外部クレート
- **ratatui + crossterm**: 特定イベント処理パターンを持つターミナルUIフレームワーク
- **serde**: log-play-serverの期待形式に合致するJSONシリアライゼーション

## コード品質とリンティング

### リンターの実行

コミット前に必ずリンターを実行:

```bash
# rustfmtでコードをフォーマット
cargo fmt

# ファイルを変更せずにフォーマットをチェック
cargo fmt -- --check

# Clippyでコード品質をチェック
cargo clippy --all-targets

# 警告をエラーとして扱うClippy (CI用)
cargo clippy --all-targets -- -D warnings
```

### コミット前チェックリスト

コミットまたはコードレビュー要求前に:

1. **コードフォーマット**: `cargo fmt` を実行して一貫したフォーマットを確保
2. **リンティング問題修正**: `cargo clippy` を実行して警告に対処
3. **ビルド成功**: `cargo build` (または `cargo build --release`) を実行
4. **テスト実行**: `cargo test` を実行して全テストが通ることを確認
5. **ドキュメント更新**: パブリックAPIを追加した場合、docコメントを更新

# userからの指示
- PRコメント
  - 作業報告は、プルリクエストのコメントに書く。document作成禁止
    - DRY原則に準拠し、「codeやbuild scriptと同じことを、documentに書いたせいで、そのdocumentが陳腐化してハルシネーションやuserレビューコスト増大や混乱ほか様々なトラブル原因になる」を防止する
    - なおissue-notes/は、userがissueごとの意図を記録する用途で使う
